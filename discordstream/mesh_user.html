<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Space Mountain Voice Mesh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #050714;
            --bg-alt: #0b0f24;
            --accent: #7b5cff;
            --text-main: #f4f4ff;
            --text-muted: #a3a5c3;
            --border-soft: #25284a;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #181b3a 0, #050714 60%);
            color: var(--text-main);
        }

        .shell {
            max-width: 1100px;
            margin: 0 auto;
            background: rgba(3, 4, 12, 0.92);
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
            padding: 16px 18px 20px;
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border-soft);
            padding-bottom: 10px;
            margin-bottom: 14px;
        }

        .title-block {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .title {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            font-size: 12px;
        }

        .meta-item {
            display: flex;
            gap: 4px;
            align-items: center;
            color: var(--text-muted);
        }

        .meta-label {
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 10px;
            color: #7f82a5;
        }

        .meta-value {
            font-weight: 500;
            color: var(--text-main);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 9px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(123, 92, 255, 0.3), rgba(0, 230, 255, 0.15));
            border: 1px solid rgba(123, 92, 255, 0.7);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .badge.voice-connected {
            background: linear-gradient(90deg, rgba(78, 225, 160, 0.3), rgba(0, 255, 128, 0.15));
            border-color: rgba(78, 225, 160, 0.7);
        }

        .badge-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #40ffb7;
            box-shadow: 0 0 10px #40ffb7;
        }

        .voice-join-panel {
            background: var(--bg-alt);
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            padding: 12px;
            margin-bottom: 14px;
        }
        
        .voice-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            margin: 4px;
        }
        
        .voice-btn:hover { background: #8b6cff; }
        .voice-btn.secondary { background: transparent; border: 1px solid var(--border-soft); }
        .voice-btn.danger { background: #ff5c7a; }
        
        .voice-input {
            padding: 8px;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text-main);
            width: 100%;
            margin: 4px 0;
        }
        
        .voice-status {
            font-size: 11px;
            color: var(--text-muted);
            margin: 4px 0;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.3fr);
            gap: 14px;
        }

        @media (max-width: 840px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-alt);
            border-radius: 10px;
            border: 1px solid var(--border-soft);
            padding: 10px 12px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .panel-title {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 11px;
        }

        .panel-extra {
            font-size: 11px;
            color: var(--text-muted);
        }

        #mesh-rooms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .room-block {
            background: radial-gradient(circle at top left, rgba(123, 92, 255, 0.18), rgba(5, 7, 20, 0.96));
            border-radius: 8px;
            border: 1px solid rgba(123, 92, 255, 0.4);
            padding: 8px 9px;
        }

        .room-block h3 {
            margin: 0 0 4px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
        }

        .room-users {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }

        .room-empty {
            font-size: 11px;
            color: var(--text-muted);
            font-style: italic;
        }

        .user-card {
            display: flex;
            gap: 7px;
            align-items: center;
            padding: 4px 5px;
            border-radius: 7px;
            background: rgba(3, 4, 12, 0.9);
            border: 1px solid rgba(57, 62, 115, 0.9);
        }

        .user-card.voice-active {
            border-color: #4ee1a0;
            background: rgba(78, 225, 160, 0.1);
        }

        .user-card.voice-muted {
            border-color: #ffd36a;
            background: rgba(255, 211, 106, 0.1);
        }

        .avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid rgba(192, 198, 255, 0.9);
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .user-name-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .user-name {
            font-size: 12px;
            font-weight: 500;
        }

        .user-source {
            font-size: 11px;
            color: var(--text-muted);
        }

        .user-stars {
            font-size: 11px;
            color: #ffd95a;
        }

        .user-roles {
            font-size: 10px;
            color: var(--text-muted);
        }

        #viewer-dropdown {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
        }

        .viewer-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 5px;
            border-radius: 6px;
            background: rgba(6, 9, 27, 0.95);
            border: 1px solid rgba(49, 52, 92, 0.8);
        }

        .viewer-icon {
            font-size: 13px;
        }

        .viewer-name {
            font-size: 12px;
        }

        .viewer-meta {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
        }

        #viewer-dropdown::-webkit-scrollbar,
        body::-webkit-scrollbar {
            width: 7px;
        }
        #viewer-dropdown::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background: rgba(123, 92, 255, 0.7);
            border-radius: 999px;
        }
    </style>
</head>
<body>
<div class="shell">
    <div class="header">
        <div class="title-block">
            <div class="title">Space Mountain Voice Mesh</div>
            <div class="subtitle">Live voice chat with mesh coordination</div>
        </div>
        <div class="meta">
            <div class="badge" id="voice-status-badge">
                <span class="badge-dot"></span>
                <span id="voice-status-text">VOICE DISCONNECTED</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Status</span>
                <span class="meta-value" id="mesh-status">‚Äì</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Last update</span>
                <span class="meta-value" id="mesh-timestamp">‚Äì</span>
            </div>
        </div>
    </div>

    <!-- Voice Join Panel -->
    <div class="voice-join-panel" id="voice-panel">
        <h3 style="margin: 0 0 8px; font-size: 14px;">üé§ Join Voice Chat</h3>
        <div style="background: rgba(123, 92, 255, 0.1); border: 1px solid rgba(123, 92, 255, 0.3); border-radius: 6px; padding: 8px; margin-bottom: 8px; font-size: 11px;">
            üé§ <strong>Microphone Required:</strong> Your browser will ask for microphone permission. Click "Allow" to enable voice chat.
        </div>
        <div id="voice-join-form">
            <input type="text" class="voice-input" id="voice-name" placeholder="Enter your name to join voice">

            <!-- Public Rooms Section -->
            <div style="margin: 8px 0;">
                <label style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px; display: block;">Public Rooms:</label>
                <select class="voice-input" id="public-rooms-select" style="margin-bottom: 4px;" title="Select a public voice room">
                    <option value="">Select a room...</option>
                </select>
                <button class="voice-btn secondary" id="join-selected-room" style="width: 100%; margin-bottom: 8px;">Join Selected Room</button>
            </div>

            <!-- Create Room Section -->
            <div style="margin: 8px 0;">
                <input type="text" class="voice-input" id="new-room-name" placeholder="Name for new public room" style="margin-bottom: 4px;">
                <button class="voice-btn secondary" id="create-public-room" style="width: 100%; margin-bottom: 8px;">Create Public Room</button>
            </div>

            <div style="display: flex; gap: 8px; align-items: center;">
                <button class="voice-btn" id="join-silent">Join Silent (Auto-muted)</button>
                <button class="voice-btn" id="join-lobby">Join Lobby</button>
                <button class="voice-btn secondary" id="create-private">Create Private Group</button>
            </div>
        </div>
        <div id="voice-controls" style="display: none;">
            <div class="voice-status" id="voice-status">Connected to voice</div>
            <div style="display: flex; gap: 8px;">
                <button class="voice-btn secondary" id="toggle-mute">üé§ Unmuted</button>
                <button class="voice-btn danger" id="leave-voice">Leave Voice</button>
            </div>
        </div>
    </div>

    <div class="layout">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Rooms</div>
                <div class="panel-extra" id="mesh-room-count">0 rooms</div>
            </div>
            <div id="mesh-rooms"></div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Crew Online</div>
                <div class="panel-extra" id="mesh-viewer-count">0 viewers</div>
            </div>
            <div id="viewer-dropdown"></div>
        </div>
    </div>
</div>

<script src="voice-client.js"></script>
<script>
// Voice integration
let voiceClient = null;
let currentUserId = null;
let voiceConnected = false;

// Voice UI elements
const voiceNameInput = document.getElementById('voice-name');
const joinSilentBtn = document.getElementById('join-silent');
const joinLobbyBtn = document.getElementById('join-lobby');
const createPrivateBtn = document.getElementById('create-private');
const voiceJoinForm = document.getElementById('voice-join-form');
const voiceControls = document.getElementById('voice-controls');
const toggleMuteBtn = document.getElementById('toggle-mute');
const leaveVoiceBtn = document.getElementById('leave-voice');
const voiceStatus = document.getElementById('voice-status');

// Initialize voice client
if (typeof VoiceClient !== 'undefined') {
    voiceClient = new VoiceClient();
    
    voiceClient.onConnectionStateChanged = (connected) => {
        voiceConnected = connected;
        updateVoiceStatus();
        if (connected) {
            voiceJoinForm.style.display = 'none';
            voiceControls.style.display = 'block';
            voiceStatus.textContent = 'Connected to voice mesh';
            // Update room dropdown when connected
            updateRoomDropdown();
        } else {
            voiceJoinForm.style.display = 'block';
            voiceControls.style.display = 'none';
        }
    };
}

function updateVoiceStatus() {
    const badge = document.getElementById('voice-status-badge');
    const text = document.getElementById('voice-status-text');
    
    if (voiceConnected) {
        badge.className = 'badge voice-connected';
        text.textContent = voiceClient && voiceClient.muted ? 'VOICE MUTED' : 'VOICE ACTIVE';
    } else {
        badge.className = 'badge';
        text.textContent = 'VOICE DISCONNECTED';
    }
}

// Voice UI elements
const publicRoomsSelect = document.getElementById('public-rooms-select');
const joinSelectedRoomBtn = document.getElementById('join-selected-room');
const newRoomNameInput = document.getElementById('new-room-name');
const createPublicRoomBtn = document.getElementById('create-public-room');

// Function to update room dropdown from voice client
function updateRoomDropdown() {
    if (!voiceClient || !voiceClient.availableRooms) return;

    publicRoomsSelect.innerHTML = '<option value="">Select a room...</option>';

    voiceClient.availableRooms.forEach(room => {
        if (room.id !== 'lobby' && room.id !== 'mod_room' && room.id !== 'silent_watch') {
            const option = document.createElement('option');
            option.value = room.id;
            option.textContent = `${room.name} (${room.userCount} users)`;
            publicRoomsSelect.appendChild(option);
        }
    });
}

// Voice button handlers
if (joinSilentBtn) {
    joinSilentBtn.addEventListener('click', () => joinVoice('silent_watch'));
}
if (joinLobbyBtn) {
    joinLobbyBtn.addEventListener('click', () => joinVoice('lobby'));
}
if (createPrivateBtn) {
    createPrivateBtn.addEventListener('click', () => {
        const roomId = 'private_' + Date.now();
        joinVoice(roomId);

        // Create shareable URL
        const shareUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
        const shareText = `Join my private voice chat: ${shareUrl}`;

        // Copy to clipboard if possible
        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareText).then(() => {
                alert('Private room created! Share link copied to clipboard:\n' + shareUrl);
            }).catch(() => {
                alert('Private room created! Share this link:\n' + shareUrl);
            });
        } else {
            alert('Private room created! Share this link:\n' + shareUrl);
        }
    });
}
if (joinSelectedRoomBtn) {
    joinSelectedRoomBtn.addEventListener('click', () => {
        const selectedRoom = publicRoomsSelect.value;
        if (selectedRoom) {
            joinVoice(selectedRoom);
        } else {
            alert('Please select a room first');
        }
    });
}
if (createPublicRoomBtn) {
    createPublicRoomBtn.addEventListener('click', () => {
        const roomName = newRoomNameInput.value.trim();
        if (!roomName) {
            alert('Please enter a room name');
            return;
        }

        // Send create room message to server
        if (voiceClient && voiceClient.ws && voiceClient.ws.readyState === WebSocket.OPEN) {
            voiceClient.ws.send(JSON.stringify({
                type: 'admin_create_room',
                payload: { roomName }
            }));
        }

        const roomId = roomName.toLowerCase().replace(/[^a-z0-9]/g, '_');
        joinVoice(roomId);
        newRoomNameInput.value = ''; // Clear input
    });
}
if (toggleMuteBtn) {
    toggleMuteBtn.addEventListener('click', () => {
        if (voiceClient) {
            const newMuted = !voiceClient.muted;
            voiceClient.setMuted(newMuted);
            toggleMuteBtn.textContent = newMuted ? 'üîá Muted' : 'üé§ Unmuted';
            updateVoiceStatus();
        }
    });
}
if (leaveVoiceBtn) {
    leaveVoiceBtn.addEventListener('click', () => {
        if (voiceClient) {
            voiceClient.disconnect();
        }
    });
}

async function joinVoice(roomId) {
    const name = voiceNameInput.value.trim();
    if (!name) {
        alert('Please enter your name');
        return;
    }

    if (!voiceClient) {
        alert('Voice client not available');
        return;
    }

    try {
        // Connect to your static domain
        const wsUrl = 'wss://mtman1987.stream';
        await voiceClient.connect(wsUrl);
        currentUserId = 'user_' + Date.now();
        await voiceClient.joinVoice(currentUserId, name, roomId);

        if (roomId === 'silent_watch') {
            voiceClient.setMuted(true);
            toggleMuteBtn.textContent = 'üîá Muted';
        }
    } catch (err) {
        console.error('Failed to join voice:', err);
        alert('Failed to join voice: ' + err.message);
    }
}

// Mesh polling (simplified)
async function pollMesh() {
    try {
        const response = await fetch("/mesh/mesh_state.json", { cache: "no-store" });
        const data = await response.json();
        updateMeshUI(data);
    } catch (err) {
        console.error("Mesh poll failed:", err);
    }
    setTimeout(pollMesh, 5000);
}

function updateMeshUI(data) {
    setText("mesh-timestamp", data.timestamp || "‚Äì");
    setText("mesh-status", (data.status || "idle").toUpperCase());

    const roomsContainer = document.getElementById("mesh-rooms");
    roomsContainer.innerHTML = "";

    const roomIds = Object.keys(data.rooms || {});
    setText("mesh-room-count", `${roomIds.length} room${roomIds.length === 1 ? "" : "s"}`);

    const users = data.users || {};
    const userIds = Object.keys(users);
    setText("mesh-viewer-count", `${userIds.length} viewer${userIds.length === 1 ? "" : "s"}`);

    // Build rooms
    roomIds.forEach(roomId => {
        const room = data.rooms[roomId];
        const roomUsers = userIds.filter(uid => users[uid].room === roomId);

        const roomDiv = document.createElement("div");
        roomDiv.className = "room-block";
        roomDiv.innerHTML = `
            <h3>${room.name} ${roomUsers.length > 0 ? 'üó£Ô∏è' : ''}</h3>
            <div class="room-users" id="room-${roomId}"></div>
        `;
        roomsContainer.appendChild(roomDiv);

        // Add users to room
        const roomContainer = roomDiv.querySelector(`#room-${roomId}`);
        roomUsers.forEach(userId => {
            const u = users[userId];
            const card = document.createElement("div");
            card.className = "user-card";
            
            if (u.voiceConnected) {
                card.classList.add('voice-active');
            }
            if (u.muted) {
                card.classList.add('voice-muted');
            }

            const voiceIndicator = u.voiceConnected ? (u.muted ? ' üîá' : ' üé§') : '';
            card.innerHTML = `
                <img class="avatar" src="${u.avatar || defaultAvatar(u.name)}" alt="">
                <div class="user-info">
                    <div class="user-name-row">
                        <span class="user-name">${u.name}${voiceIndicator}</span>
                        <span class="user-source">${sourceLabel(u.source)}</span>
                    </div>
                    <div class="user-stars">${u.stars > 0 ? "‚≠ê".repeat(u.stars) : ""}</div>
                    <div class="user-roles">${(u.roles || []).join(", ")}</div>
                </div>
            `;
            roomContainer.appendChild(card);
        });

        if (roomUsers.length === 0) {
            const empty = document.createElement("div");
            empty.className = "room-empty";
            empty.textContent = "No crew here yet.";
            roomContainer.appendChild(empty);
        }
    });

    // Fill viewer dropdown
    const dropdown = document.getElementById("viewer-dropdown");
    dropdown.innerHTML = "";
    userIds.forEach(userId => {
        const u = users[userId];
        const ddItem = document.createElement("div");
        ddItem.className = "viewer-item";
        ddItem.innerHTML = `
            <span class="viewer-icon">${sourceIcon(u.source)}</span>
            <span class="viewer-name">${u.name}</span>
            <span class="viewer-meta">${u.room}</span>
        `;
        dropdown.appendChild(ddItem);
    });
}

function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

function sourceIcon(src) {
    if (!src) return "üåå";
    const s = src.toLowerCase();
    if (s === "twitch") return "üéÆ";
    if (s === "discord") return "üí¨";
    return "üåå";
}

function sourceLabel(src) {
    if (!src) return "";
    const s = src.toLowerCase();
    if (s === "twitch") return "Twitch";
    if (s === "discord") return "Discord";
    return "";
}

function defaultAvatar(name) {
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name || "?")}&background=333344&color=ffffff`;
}

pollMesh();
</script>
</body>
</html>