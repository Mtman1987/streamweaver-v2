<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Cosmic Mesh â€“ Public UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --bg: rgba(5, 8, 20, 0.65);
    --text: #e8ecff;
    --text-muted: #9aa3c7;
    --accent: #7aa2ff;
    --border: rgba(120, 160, 255, 0.25);
    --radius: 8px;
    --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: var(--font);
    background: transparent;
    color: var(--text);
  }

  .public-shell {
    width: 260px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 8px 10px;
    backdrop-filter: blur(6px);
    overflow: hidden;
    transition: background 0.2s ease;
  }

  .chroma-on {
    background: #00ff00 !important;
    border-color: #00ff00 !important;
    backdrop-filter: none !important;
  }

  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
    position: relative;
  }

  .header-text {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  #chromaToggle {
    background: transparent;
    border: none;
    color: #fff;
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 6px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease;
    position: absolute;
    left: 0;
  }

  .header-bar:hover #chromaToggle {
    opacity: 1;
  }

  .scroll-window {
    height: 150px;
    overflow: hidden;
    position: relative;
  }

  .viewer-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    position: absolute;
    width: 100%;
    left: 0;
    top: 0;
  }

  .viewer {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    background: rgba(10, 14, 30, 0.55);
    border-radius: var(--radius);
    border: 1px solid rgba(120, 160, 255, 0.15);
  }

  .viewer.voice-active {
    border-color: #4ee1a0;
    background: rgba(78, 225, 160, 0.2);
  }

  .viewer.voice-muted {
    border-color: #ffd36a;
    background: rgba(255, 211, 106, 0.2);
  }

  .avatar {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .info {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .name-row {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .meta {
    font-size: 0.7rem;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .stars {
    color: #ffd36a;
    font-size: 0.75rem;
  }
</style>
</head>

<body>
<div class="public-shell">

  <div class="header-bar">
    <button id="chromaToggle">âœ•</button>
    <div class="header-text">CREW ONLINE</div>
  </div>

  <div class="scroll-window">
    <div id="viewerList" class="viewer-list">
      <!-- Filled by JS -->
    </div>
  </div>
</div>

<script>
const MESH_URL = "https://mesh.mtman1987.stream/mesh/mesh_state.json";
let meshState = null;
let scrollPos = 0;
let scrollSpeed = 0.4;
let listHeight = 0;

document.getElementById("chromaToggle").addEventListener("click", () => {
  document.querySelector(".public-shell").classList.toggle("chroma-on");
});

function sourceIcon(src) {
  if (!src) return "ðŸŒŒ";
  src = src.toLowerCase();
  if (src === "twitch") return "ðŸŽ®";
  if (src === "discord") return "ðŸ’¬";
  if (src === "cosmic") return "âœ¨";
  return "ðŸŒŒ";
}

function defaultAvatar(name) {
  return `https://ui-avatars.com/api/?name=${encodeURIComponent(name || "?")}&background=1a1f3a&color=ffffff`;
}

async function pollMesh() {
  try {
    const res = await fetch(MESH_URL, { cache: "no-store" });
    const data = await res.json();
    meshState = data;
    renderViewers(data);
  } catch (err) {
    console.error("Public UI mesh poll failed:", err);
  }
  setTimeout(pollMesh, 5000);
}

function renderViewers(state) {
  const list = document.getElementById("viewerList");
  list.innerHTML = "";

  if (!state || !state.users) return;

  const users = Object.entries(state.users);

  users.forEach(([uid, u]) => {
    const viewer = document.createElement("div");
    viewer.className = "viewer";
    
    // Add voice status classes
    if (u.voiceConnected) {
      viewer.classList.add('voice-active');
    }
    if (u.muted) {
      viewer.classList.add('voice-muted');
    }

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    const img = document.createElement("img");
    img.src = u.avatar || defaultAvatar(u.name);
    avatar.appendChild(img);

    const info = document.createElement("div");
    info.className = "info";

    const voiceStatus = u.voiceConnected ? (u.muted ? ' (muted)' : ' (chatting)') : '';
    const nameRow = document.createElement("div");
    nameRow.className = "name-row";
    nameRow.innerHTML = `
      <span>${sourceIcon(u.source)}</span>
      <span>${u.name}${voiceStatus}</span>
    `;

    const meta = document.createElement("div");
    meta.className = "meta";
    const stars = Number.isInteger(u.stars) ? u.stars : 0;
    const roles = Array.isArray(u.roles) ? u.roles.join(", ") : "";
    meta.innerHTML = `
      <span class="stars">âœ¦ ${stars}</span>
      ${roles ? ` Â· ${roles}` : ""}
    `;

    info.appendChild(nameRow);
    info.appendChild(meta);

    viewer.appendChild(avatar);
    viewer.appendChild(info);

    list.appendChild(viewer);
  });

  const clone = list.cloneNode(true);
  clone.id = "";
  list.parentNode.appendChild(clone);
  listHeight = list.offsetHeight;
}

function animateScroll() {
  const list = document.getElementById("viewerList");
  const clone = list.nextElementSibling;

  scrollPos += scrollSpeed;

  list.style.transform = `translateY(-${scrollPos}px)`;
  clone.style.transform = `translateY(-${scrollPos - listHeight}px)`;

  if (scrollPos >= listHeight) {
    scrollPos = 0;
  }

  requestAnimationFrame(animateScroll);
}

pollMesh();
animateScroll();
</script>
</body>
</html>
