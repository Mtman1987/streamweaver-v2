<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Space Mountain Voice Lobby</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            --bg: #050714;
            --bg-alt: #0b0f24;
            --accent: #7b5cff;
            --text-main: #f4f4ff;
            --text-muted: #a3a5c3;
            --border-soft: #25284a;
            --success: #4ee1a0;
            --danger: #ff5c7a;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, sans-serif;
            background: radial-gradient(circle at top, #181b3a 0, #050714 60%);
            color: var(--text-main);
        }
        .shell {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(3, 4, 12, 0.92);
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-soft);
        }
        .title { font-size: 24px; font-weight: 600; margin: 0; }
        .subtitle { font-size: 14px; color: var(--text-muted); margin: 5px 0 0; }
        .voice-panel {
            background: var(--bg-alt);
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            padding: 20px;
            margin-bottom: 20px;
        }
        .voice-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text-main);
            margin-bottom: 15px;
            font-size: 14px;
        }
        .voice-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            background: var(--accent);
            color: white;
            margin: 5px;
        }
        .voice-btn:hover { background: #8b6cff; }
        .voice-btn.secondary { background: transparent; border: 1px solid var(--border-soft); }
        .voice-btn.danger { background: var(--danger); }
        .voice-btn.success { background: var(--success); }
        .voice-status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 12px;
        }
        .status-connected { background: rgba(78, 225, 160, 0.2); border: 1px solid var(--success); }
        .status-disconnected { background: rgba(255, 92, 122, 0.2); border: 1px solid var(--danger); }
        .users-list {
            background: var(--bg-alt);
            border-radius: 8px;
            border: 1px solid var(--border-soft);
            padding: 15px;
        }
        .user-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            background: rgba(3, 4, 12, 0.9);
            border: 1px solid rgba(57, 62, 115, 0.9);
            margin-bottom: 8px;
        }
        .user-item.voice-active { border-color: var(--success); background: rgba(78, 225, 160, 0.1); }
        .user-item.voice-muted { border-color: #ffd36a; }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="shell">
    <div class="header">
        <div class="title">ðŸŽ¤ Voice Lobby</div>
        <div class="subtitle">Simple P2P voice chat for up to 5 people</div>
    </div>

    <div class="voice-panel">
        <div id="join-form">
            <input type="text" class="voice-input" id="username" placeholder="Enter your name">
            <div style="text-align: center;">
                <button class="voice-btn" id="join-btn">ðŸŽ¤ Join Voice Chat</button>
            </div>
        </div>
        
        <div id="voice-controls" style="display: none;">
            <div class="voice-status status-connected" id="status">Connected to voice chat</div>
            <div style="text-align: center;">
                <button class="voice-btn secondary" id="mute-btn">ðŸŽ¤ Unmuted</button>
                <button class="voice-btn danger" id="leave-btn">Leave</button>
            </div>
        </div>
    </div>

    <div class="users-list">
        <h3 style="margin: 0 0 15px; font-size: 16px;">ðŸ‘¥ Voice Users</h3>
        <div id="users-container">
            <div style="text-align: center; color: var(--text-muted); font-style: italic;">
                No one in voice chat yet
            </div>
        </div>
    </div>
</div>

<script>
class SimpleVoiceChat {
    constructor() {
        this.localStream = null;
        this.peers = new Map();
        this.userId = null;
        this.userName = null;
        this.muted = false;
        this.users = new Map();
        
        this.setupUI();
    }
    
    setupUI() {
        const joinBtn = document.getElementById('join-btn');
        const leaveBtn = document.getElementById('leave-btn');
        const muteBtn = document.getElementById('mute-btn');
        const usernameInput = document.getElementById('username');
        
        joinBtn.addEventListener('click', () => this.joinVoice());
        leaveBtn.addEventListener('click', () => this.leaveVoice());
        muteBtn.addEventListener('click', () => this.toggleMute());
        
        // Enter key to join
        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.joinVoice();
        });
    }
    
    async joinVoice() {
        const username = document.getElementById('username').value.trim();
        if (!username) {
            alert('Please enter your name');
            return;
        }
        
        try {
            // Get microphone access
            this.localStream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: true, noiseSuppression: true },
                video: false
            });
            
            this.userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            this.userName = username;
            
            // Add ourselves to users list
            this.users.set(this.userId, {
                name: username,
                muted: false,
                speaking: false
            });
            
            // Show voice controls
            document.getElementById('join-form').style.display = 'none';
            document.getElementById('voice-controls').style.display = 'block';
            
            this.updateUsersDisplay();
            
            console.log('Joined voice chat as:', username);
            
        } catch (err) {
            console.error('Failed to get microphone:', err);
            if (err.name === 'NotAllowedError') {
                alert('Microphone access denied. Please allow microphone access and try again.');
            } else {
                alert('Failed to access microphone: ' + err.message);
            }
        }
    }
    
    leaveVoice() {
        // Stop local stream
        if (this.localStream) {
            this.localStream.getTracks().forEach(track => track.stop());
            this.localStream = null;
        }
        
        // Close all peer connections
        this.peers.forEach(peer => peer.close());
        this.peers.clear();
        
        // Remove ourselves from users
        this.users.delete(this.userId);
        
        // Show join form
        document.getElementById('join-form').style.display = 'block';
        document.getElementById('voice-controls').style.display = 'none';
        
        this.updateUsersDisplay();
        
        console.log('Left voice chat');
    }
    
    toggleMute() {
        this.muted = !this.muted;
        
        if (this.localStream) {
            this.localStream.getAudioTracks().forEach(track => {
                track.enabled = !this.muted;
            });
        }
        
        // Update our user info
        if (this.users.has(this.userId)) {
            this.users.get(this.userId).muted = this.muted;
        }
        
        // Update UI
        const muteBtn = document.getElementById('mute-btn');
        muteBtn.textContent = this.muted ? 'ðŸ”‡ Muted' : 'ðŸŽ¤ Unmuted';
        muteBtn.className = this.muted ? 'voice-btn danger' : 'voice-btn secondary';
        
        this.updateUsersDisplay();
        
        console.log(this.muted ? 'Muted' : 'Unmuted');
    }
    
    updateUsersDisplay() {
        const container = document.getElementById('users-container');
        
        if (this.users.size === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-style: italic;">No one in voice chat yet</div>';
            return;
        }
        
        container.innerHTML = '';
        
        this.users.forEach((user, userId) => {
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            
            if (userId === this.userId && !user.muted) {
                userDiv.classList.add('voice-active');
            } else if (user.muted) {
                userDiv.classList.add('voice-muted');
            }
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = user.name.charAt(0).toUpperCase();
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = user.name;
            if (userId === this.userId) nameSpan.textContent += ' (You)';
            
            const statusSpan = document.createElement('span');
            statusSpan.style.marginLeft = 'auto';
            statusSpan.style.fontSize = '12px';
            statusSpan.textContent = user.muted ? 'ðŸ”‡' : 'ðŸŽ¤';
            
            userDiv.appendChild(avatar);
            userDiv.appendChild(nameSpan);
            userDiv.appendChild(statusSpan);
            
            container.appendChild(userDiv);
        });
    }
}

// Initialize voice chat
const voiceChat = new SimpleVoiceChat();

// For P2P with 5 people: Each person connects to 4 others = 10 total connections
// This works but gets complex. For now, this is a local-only demo.
// To make it work across the internet, you'd need:
// 1. A signaling server (WebSocket) to exchange connection info
// 2. STUN/TURN servers for NAT traversal
// 3. Mesh coordination through your existing mesh system

console.log('Voice lobby ready. P2P connections would need signaling server for internet use.');
</script>
</body>
</html>